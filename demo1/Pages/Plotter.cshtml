@page "/Plotter"
<h1>Plotter</h1>

<hr>
<!-- 
<div id="myDiv"></div>
--> 
<div id="myDiv" style="width: 600px; height: 400px;"></div>



<script>


var showthis = 
{
	//"miloatv_sensors": ["humidity", "timestamp", "temperature"]
};

if(window.location.hash)
{
	var h = window.location.hash.substring(1);
	console.log(h);
	var k = atob(decodeURIComponent(h));
	console.log(k);
	showthis = JSON.parse(k);
	console.log(showthis);
}
else
{
  // Fragment doesn't exist
}




function newplotter(archetypes)
{
	var traces = [];
	var traceindex = 0;
	var hastimestamp = false;

	for (archetype in archetypes)
	{
		var components = archetypes[archetype].components;
		for (component in components)
		{
			if (component == "timestamp")
			{
				hastimestamp = true;
			}
		}
	}


	for (archetype in archetypes)
	{
		var components = archetypes[archetype].components;
		for (component in components)
		{
			let cell = components[component]._cell;
			let quantity = components[component].quantity;
			components[component]._traceindex = traceindex;
			if (component != "timestamp")
			{
				traceindex++;
				var trace = 
				{
					y: [],
					mode: 'lines',
					name: component,
					line: {color: colors[quantity]}
				};
				if (hastimestamp)
				{
					trace.x = [];
				}
				traces.push(trace);
			}
		}
	}
	var layout = {showlegend: true};
	//https://plotly.com/javascript/streaming/
	Plotly.newPlot('myDiv', traces, layout);
}







var client = mqtt.connect("ws://192.168.1.195:1884");
client.on('connect', function () 
{
	console.log("mqtt connected");
});




req_json('archetypes', (archetypes) => 
{
	for (archetype in archetypes)
	{
		if (showthis[archetype] == null)
		{
			delete archetypes[archetype];
			continue;
		}
		var components = archetypes[archetype].components;
		for (component in components)
		{
			if (showthis[archetype].includes(component) == false)
			{
				delete components[component];
			}
		}
	}
	console.log("archetypes", archetypes);

	newplotter(archetypes);

	
	for (topic in archetypes)
	{
		console.log("subscribe: " + topic);
		client.subscribe(topic);
	}


	client.on("message", function (topic, payload)
	{
		var tracex = [];
		var tracey = [];
		var tracei = [];
		var timestamp = null;
		console.log(payload);
		//console.log(fluff(payload));
		//dataview = new DataView(fluff(payload).buffer);
		var components = archetypes[topic].components;
		for (component in components)
		{
			//Warning! The payload does not start at byte 0!
			dataview = new DataView(payload.buffer, payload.byteOffset + components[component].offset);
			var s = converters[component](dataview);
			if (component == "timestamp")
			{
				timestamp = s;
			}
			else
			{
				tracey.push([s]);
				tracei.push(components[component]._traceindex);
			}
		}
		if (timestamp != null)
		{
			for (let i = 0; i < tracei.length; i++)
			{
				tracex.push([timestamp]);
			}
		}
		if (tracei.length > 0)
		{
			if (tracei.length == tracex.length)
			{
				//console.log(tracey, tracei);
				Plotly.extendTraces('myDiv', {x:tracex, y: tracey}, tracei);
			}
			else
			{
				Plotly.extendTraces('myDiv', {y: tracey}, tracei);
			}
		}
	});


});



</script>